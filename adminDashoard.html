<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN DASHBOARD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- For Hash pasword Lib -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
</head>
<body class="bg-gray-100">
    <div class="flex flex-col gap-10">
        <!-- Navbar -->
        <nav class="bg-blue-500 p-4">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                <span class="text-white text-lg font-bold">Task Manager</span>
                <div>
                    <button id="requestDisplay" class="bg-blue-700 text-white px-4 py-2 rounded mr-2">Requests</button>
                    <button id="profile" class="bg-blue-700 text-white px-4 py-2 rounded mr-2">Profile</button>
                    <button id="logout" class="bg-red-500 text-white px-4 py-2 rounded">Logout</button>
                </div>
            </div>
        </nav>
    
        <div class="flex gap-8 self-center">
            <div class="bg-white rounded-xl border p-10 flex flex-col gap-5 text-green-500">
                <div class="text-2xl font-bold text-center">Total Approved Requests</div>
                <div id="totalApprovedRequests" class="text-6xl font-bold text-center">0</div>
            </div>
        
            <div class="bg-white rounded-xl border p-10 flex flex-col gap-5 text-orange-500">
                <div class="text-2xl font-bold text-center">Total Tasks</div>
                <div id="totalTasks" class="text-6xl font-bold text-center">0</div>
            </div>
        </div>
        

        <!-- Request Modal -->
        <div id="requestModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center">
            <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Requests</h2>
                    <button id="closeRequest" class="text-gray-600 hover:text-gray-900">&times;</button>
                </div>
                <div id="displayRequest_DIV">
                    <!-- Requests will be dynamically added here -->
                </div>
            </div>
        </div>
    
        <!-- Profile Modal -->
        <div id="profileModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center">
            <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Profile</h2>
                    <button id="closeProfile" class="text-gray-600 hover:text-gray-900">&times;</button>
                </div>
                <div>
                    <p><strong>Email:</strong> <span id="profileEmail"></span></p>
                    <p><strong>Account Type:</strong> <span id="profileAccountType"></span></p>
                </div>
                <button id="editProfile" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded">Edit</button>
            </div>
        </div>
        
        <!-- Edit Profile Modal -->
        <div id="editProfileModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center">
            <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Edit Profile</h2>
                    <button id="closeEditProfile" class="text-gray-600 hover:text-gray-900">&times;</button>
                </div>
                <form id="editProfileForm">
                    <div class="mb-4">
                        <label class="block text-gray-700" for="editEmail">Email</label>
                        <input class="w-full p-2 border border-gray-300 rounded mt-2" type="email" id="editEmail" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700" for="editPassword">Password</label>
                        <input class="w-full p-2 border border-gray-300 rounded mt-2" type="password" id="editPassword">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700" for="editAccountType">Account Type</label>
                        <select class="w-full p-2 border border-gray-300 rounded mt-2" id="editAccountType" required>
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <button class="w-full bg-blue-500 text-white py-2 rounded" type="submit">Save</button>
                </form>
            </div>
        </div>

    </div>


<script>

document.addEventListener("DOMContentLoaded", function () {

    document.getElementById('logout').addEventListener('click', () => {
            sessionStorage.removeItem('user');
            window.location.href = './loginAndRgister.html';
        });

    const requestDisplayButton = document.getElementById('requestDisplay');
    const requestModal = document.getElementById('requestModal');
    const closeRequestButton = document.getElementById('closeRequest');
    const dataDisplayDiv = document.getElementById('diplayRequest_DIV');

    const totalApprovedRequestsElement = document.getElementById('totalApprovedRequests');
    const totalTasksElement = document.getElementById('totalTasks');

    let db;
    const request = indexedDB.open('Requests', 1);

    request.onupgradeneeded = function(event) {
        db = event.target.result;
        if (!db.objectStoreNames.contains('requests')) {
            const objectStore = db.createObjectStore('requests', { keyPath: 'id', autoIncrement: true });
            objectStore.createIndex('requestStatus', 'requestStatus', { unique: false });
            objectStore.createIndex('receiver_Email', 'receiver_Email', { unique: false });
        }
    };

    request.onsuccess = function(event) {
        db = event.target.result;
        updateTotals(); // Initial totals update
    };

    let db2;
    const request2 = indexedDB.open("Tasks", 1);

    request2.onupgradeneeded = function(event) {
        db2 = event.target.result;
        if (!db2.objectStoreNames.contains('tasks')) {
            db2.createObjectStore('tasks', { keyPath: 'id', autoIncrement: true });
        }
    };

    request2.onsuccess = function(event) {
        db2 = event.target.result;
    };

    requestDisplayButton.addEventListener('click', function () {
        displayRequests();
        requestModal.classList.remove('hidden');
    });

    closeRequestButton.addEventListener('click', function () {
        requestModal.classList.add('hidden');
    });

    function displayRequests() {
        const transaction = db.transaction(['requests'], 'readonly');
        const objectStore = transaction.objectStore('requests');
        const request = objectStore.getAll();

        let dataDisplayDiv = document.getElementById('displayRequest_DIV');

        dataDisplayDiv.innerHTML = ''; // Clear previous requests

        request.onsuccess = function(event) {
            const allData = event.target.result;
            const pendingRequests = allData.filter(dataItem => dataItem.requestStatus !== 'approved' && dataItem.requestStatus !== 'rejected');
            
            if (pendingRequests.length === 0) {
                dataDisplayDiv.innerHTML = '<p>No pending requests.</p>';
            } else {
                pendingRequests.forEach(dataItem => {
                    const div = document.createElement('div');
                    div.className = "flex justify-between items-center mb-2";
                    div.innerHTML = `
                        <div class="self-center font-semibold text-xl">${dataItem.sender_Email}</div>
                        <div class="flex gap-2 self-center">
                            <button onclick="editRequest('approve', ${dataItem.id})" class="mt-4 bg-green-500 text-white px-4 py-2 rounded">Approve</button>
                            <button onclick="editRequest('reject', ${dataItem.id})" class="mt-4 bg-red-500 text-white px-4 py-2 rounded">Reject</button>
                        </div>`;
                    dataDisplayDiv.appendChild(div);
                });
            }
        };
    }

    window.editRequest = function (action, id) {
        const transaction = db.transaction(['requests'], 'readwrite');
        const objectStore = transaction.objectStore('requests');
        const request = objectStore.get(id);

        request.onsuccess = function(event) {
            const data = event.target.result;


            if (action == 'approve') {
                data.requestStatus = 'approved';
            }
            else{
                data.requestStatus ='rejected';
            }
            const updateRequest = objectStore.put(data);

            updateRequest.onsuccess = function(event) {
                displayRequests(); // Refresh the displayed requests
                updateTotals(); // Update the totals after approving a request
            };
        };
    };


    function updateTotals() {
        let user = JSON.parse(sessionStorage.getItem('user'));
        let email = user.email;


        // const transaction = db.transaction(['requests'], 'readonly');
        // const objectStore = transaction.objectStore('requests');

        // const approvedRequestCount = objectStore.index('requestStatus').count('approved');

        // approvedRequestCount.onsuccess = function(event) {
        //     totalApprovedRequestsElement.textContent = event.target.result;
        // };


        const requestTransaction = db.transaction(['requests'], 'readonly');
        const requestObjectStore = requestTransaction.objectStore('requests');
        const requestQuery = requestObjectStore.index('reciever_Email').getAll(email);

        requestQuery.onsuccess = function(event) {
            const userRequests = event.target.result;
            const approvedUserRequests = userRequests.filter(request => request.requestStatus === 'approved');

            if (approvedUserRequests.length > 0) {

                
                totalApprovedRequestsElement.textContent = approvedUserRequests.length;
                let countTasks = 0;
                for (let i = 0; i < approvedUserRequests.length; i++) {
                    
                    const senderEmail = approvedUserRequests[i].sender_Email;
                    const taskTransaction = db2.transaction(['tasks'], 'readonly');
                    const taskObjectStore = taskTransaction.objectStore('tasks');
                    const taskQuery = taskObjectStore.index('email').count(senderEmail);
    
                    taskQuery.onsuccess = function(event) {
                        // console.log(event.target.result);
                        countTasks += event.target.result;
                        totalTasksElement.textContent = countTasks ;
                    };
                    // console.log(event.target.result);
                }
                // console.log(countTasks);
            } else {
                totalTasksElement.textContent = '0';
            }
        };
    }





    let user = JSON.parse(sessionStorage.getItem('user'));
    if (!user) {
        window.location.href = './loginAndRgister.html';
    } else {
        // document.getElementById('userDe  tails').innerText = `Welcome, ${user.email} (${user.accountType})`;
        document.getElementById('profileEmail').innerText = user.email;
        document.getElementById('profileAccountType').innerText = user.accountType;
    }

    document.getElementById('profile').addEventListener('click', () => {
        document.getElementById('profileModal').classList.remove('hidden');
    });

    document.getElementById('closeProfile').addEventListener('click', () => {
        document.getElementById('profileModal').classList.add('hidden');
    });

    document.getElementById('profileModal').addEventListener('click', (event) => {
        if (event.target === document.getElementById('profileModal')) {
            document.getElementById('profileModal').classList.add('hidden');
        }
    });


    document.getElementById('editProfile').addEventListener('click', () => {
            document.getElementById('editEmail').value = user.email;
            document.getElementById('editAccountType').value = user.accountType;
            document.getElementById('profileModal').classList.add('hidden');
            document.getElementById('editProfileModal').classList.remove('hidden');
        });

        document.getElementById('closeEditProfile').addEventListener('click', () => {
            document.getElementById('editProfileModal').classList.add('hidden');
        });

        document.getElementById('editProfileModal').addEventListener('click', (event) => {
            if (event.target === document.getElementById('editProfileModal')) {
                document.getElementById('editProfileModal').classList.add('hidden');
            }
        });

        let db3;
        const request3 = indexedDB.open('UserDatabase', 1);

        request3.onerror = function(event) {
            console.error('Database error:', event.target.errorCode);
        };

        request3.onsuccess = function(event) {
            db3 = event.target.result;
        };

        request3.onupgradeneeded = function(event) {
            db3 = event.target.result;
            const objectStore = db3.createObjectStore('users', { keyPath: 'email' });
            objectStore.createIndex('email', 'email', { unique: true });
            objectStore.createIndex('accountType', 'accountType', { unique: false });
        };

        document.getElementById('editProfileForm').addEventListener('submit', (event) => {
            event.preventDefault();
            const newEmail = document.getElementById('editEmail').value;
            const newPassword = document.getElementById('editPassword').value;
            const newAccountType = document.getElementById('editAccountType').value;
            const hashedPassword = newPassword ? CryptoJS.SHA256(newPassword).toString() : user.password;

            const transaction = db3.transaction(['users'], 'readwrite');
            const objectStore = transaction.objectStore('users');

            // Delete the old record if the email has changed
            if (newEmail !== user.email) {
                objectStore.delete(user.email).onsuccess = function() {
                    const request3 = objectStore.put({ email: newEmail, password: hashedPassword, accountType: newAccountType });

                    request3.onsuccess = function() {
                        sessionStorage.setItem('user', JSON.stringify({ email: newEmail, password: hashedPassword, accountType: newAccountType }));
                        // displayMessage('editProfileMessage', 'Profile updated successfully', 'success');
                        document.getElementById('editProfileModal').classList.add('hidden');
                        window.location.reload();
                    };

                    request3.onerror = function(event) {
                        // displayMessage('editProfileMessage', 'Unable to update profile', 'error');
                        console.error('Error:', event.target.errorCode);
                    };
                };
            } else {
                const request3 = objectStore.put({ email: newEmail, password: hashedPassword, accountType: newAccountType });

                request3.onsuccess = function() {
                    sessionStorage.setItem('user', JSON.stringify({ email: newEmail, password: hashedPassword, accountType: newAccountType }));
                    // displayMessage('editProfileMessage', 'Profile updated successfully', 'success');
                    document.getElementById('editProfileModal').classList.add('hidden');
                    window.location.reload();
                };

                request3.onerror = function(event) {
                    // displayMessage('editProfileMessage', 'Unable to update profile', 'error');
                    console.error('Error:', event.target.errorCode);
                };
            }
        });

});

</script>

</body>
</html>